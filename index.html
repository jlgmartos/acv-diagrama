<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>Diagrama ACV (SVG interactivo)</title>
<style>
  html,body{margin:0;height:100%;background:#fff;color:#111;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  #wrap{height:100vh;display:flex;flex-direction:column}
  #stage{flex:1;overflow:hidden;touch-action:pinch-zoom pan-x pan-y;background:#fff}
  #stage svg{width:100%;height:100%;display:block}
  /* hoja descriptiva */
  .sheet{position:fixed;left:0;right:0;bottom:0;background:#fff;box-shadow:0 -8px 24px rgba(0,0,0,.2);
    border-top-left-radius:12px;border-top-right-radius:12px;padding:16px 20px 24px;max-height:60vh;overflow:auto;
    transform:translateY(110%);transition:.25s ease;z-index:10}
  .sheet.show{transform:translateY(0)}
  .sheet h3{margin:.25rem 2rem .5rem 0;font-size:1rem}
  .sheet p{margin:0;line-height:1.45;white-space:pre-wrap}
  .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.25);opacity:0;pointer-events:none;transition:.2s ease;z-index:9}
  .backdrop.show{opacity:1;pointer-events:auto}
  .close{position:absolute;right:12px;top:10px;font-size:20px;border:0;background:transparent;cursor:pointer}
  /* indicador de arrastre para escritorio */
  @media (pointer:coarse){ .hint{display:none} }
  .hint{position:fixed;left:10px;bottom:10px;font-size:.85rem;background:#fff;border:1px solid #ddd;border-radius:8px;padding:6px 10px}
</style>
</head>
<body>
<div id="wrap">
  <div id="stage">
    <!-- PEGAR AQUÍ EL SVG EXPORTADO (tal cual) -->
  </div>
</div>

<div class="backdrop" id="bd"></div>
<div class="sheet" id="sheet">
  <button class="close" id="close" aria-label="Cerrar">×</button>
  <h3 id="title"></h3>
  <p id="desc"></p>
</div>
<div class="hint">Rueda/trackpad: zoom · Arrastrar: mover</div>

<script>
(function(){
  const stage = document.getElementById('stage');
  const sheet = document.getElementById('sheet');
  const bd = document.getElementById('bd');
  const tEl = document.getElementById('title');
  const dEl = document.getElementById('desc');
  const close = document.getElementById('close');

  function openSheet(title, text){ tEl.textContent=title||''; dEl.textContent=text||''; sheet.classList.add('show'); bd.classList.add('show'); }
  function closeSheet(){ sheet.classList.remove('show'); bd.classList.remove('show'); }
  close.addEventListener('click', closeSheet); bd.addEventListener('click', closeSheet);

  // Pan & Zoom básicos sobre el <svg>
  let svg, viewBox, isPanning=false, start={x:0,y:0}, vb={x:0,y:0,w:0,h:0};
  function initPanZoom(){
    svg = stage.querySelector('svg');
    if(!svg) return;
    const vbStr = svg.getAttribute('viewBox');
    if(!vbStr) {
      // crea un viewBox por defecto a partir del tamaño
      const w = svg.viewBox && svg.viewBox.baseVal ? svg.viewBox.baseVal.width : svg.clientWidth||1000;
      const h = svg.viewBox && svg.viewBox.baseVal ? svg.viewBox.baseVal.height: svg.clientHeight||800;
      svg.setAttribute('viewBox', `0 0 ${w} ${h}`);
    }
    viewBox = svg.viewBox.baseVal;
    vb = {x:viewBox.x,y:viewBox.y,w:viewBox.width,h:viewBox.height};

    svg.addEventListener('wheel', (e)=>{
      e.preventDefault();
      const scale = (e.deltaY<0)? 0.9 : 1.1;
      const mx = e.offsetX / svg.clientWidth;
      const my = e.offsetY / svg.clientHeight;
      const nx = vb.x + mx*vb.w;
      const ny = vb.y + my*vb.h;
      vb.w *= scale; vb.h *= scale;
      vb.x = nx - mx*vb.w; vb.y = ny - my*vb.h;
      svg.setAttribute('viewBox', `${vb.x} ${vb.y} ${vb.w} ${vb.h}`);
    }, {passive:false});

    svg.addEventListener('pointerdown', (e)=>{ isPanning=true; start={x:e.clientX,y:e.clientY}; svg.setPointerCapture(e.pointerId); });
    svg.addEventListener('pointermove', (e)=>{
      if(!isPanning) return;
      const dx = (e.clientX - start.x) * (vb.w/svg.clientWidth);
      const dy = (e.clientY - start.y) * (vb.h/svg.clientHeight);
      vb.x -= dx; vb.y -= dy;
      start={x:e.clientX,y:e.clientY};
      svg.setAttribute('viewBox', `${vb.x} ${vb.y} ${vb.w} ${vb.h}`);
    });
    svg.addEventListener('pointerup', ()=>{ isPanning=false; });
    svg.addEventListener('pointerleave', ()=>{ isPanning=false; });
  }

  // Click en cajas: buscar la descripción (draw.io mete el XML dentro del SVG)
  function initCellClicks(){
    svg = stage.querySelector('svg');
    if(!svg) return;

    // 1) localizar el XML incrustado (mxfile) y parsearlo
    const descMap = new Map(); // idCell -> {title, desc}
    try{
      // El SVG exportado por draw.io suele incluir un <svg><foreignObject> o <metadata> con el .drawio
      const raw = new XMLSerializer().serializeToString(svg);
      const match = raw.match(/<mxfile[\\s\\S]*?<\\/mxfile>/);
      if(match){
        const xml = (new window.DOMParser()).parseFromString(match[0], 'text/xml');
        const cells = xml.getElementsByTagName('mxCell');
        for (const c of cells){
          const id = c.getAttribute('id');
          // el label/valor suele estar en el padre <object> o en el propio 'value'
          let title = (c.getAttribute('value')||'').replace(/<[^>]*>/g,'').trim();
          let desc = c.getAttribute('Descripcion') || '';
          const parent = c.parentElement;
          if(parent && parent.tagName && parent.tagName.toLowerCase()==='object'){
            title = parent.getAttribute('label') || title;
            if(!desc) desc = parent.getAttribute('Descripcion') || '';
          }
          if(id && (title || desc)) descMap.set(id, {title, desc});
        }
      }
    }catch(err){ console.warn('No pude extraer mxfile del SVG:', err); }

    // 2) cada shape del SVG suele tener data-mxcell-id o id basados en la celda
    svg.querySelectorAll('[data-mxcell-id], g[id]').forEach(el=>{
      const cid = el.getAttribute('data-mxcell-id') || el.id;
      if(!cid) return;
      el.style.cursor = 'pointer';
      el.addEventListener('click', (e)=>{
        const info = descMap.get(cid);
        if(info && (info.title || info.desc)){
          openSheet(info.title || 'Elemento', info.desc || 'Sin descripción');
          e.stopPropagation();
        }
      });
    });
  }

  // Inicializar cuando esté el SVG
  const obs = new MutationObserver(()=>{
    if(stage.querySelector('svg')){
      obs.disconnect();
      initPanZoom();
      initCellClicks();
    }
  });
  obs.observe(stage, {childList:true, subtree:true});
})();
</script>
</body>
</html>
